<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title> متابعة أعطال السيرفرات والأدوات</title>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .sync-status {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #2ecc71;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .sharing-notice {
            background: #e8f4fd;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            margin: 20px;
            text-align: center;
        }

        .sharing-notice h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .sharing-notice p {
            color: #34495e;
            margin-bottom: 15px;
        }

        .form-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 1rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .priority-high { background-color: #ffebee !important; border-color: #f44336 !important; color: #c62828 !important; }
        .priority-medium { background-color: #fff3e0 !important; border-color: #ff9800 !important; color: #ef6c00 !important; }
        .priority-low { background-color: #e8f5e8 !important; border-color: #4caf50 !important; color: #2e7d32 !important; }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2980b9, #1f618d);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-export {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-export:hover {
            background: linear-gradient(135deg, #229954, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
        }
         .btn-secondary:hover {
            background: linear-gradient(135deg, #7b3a9a, #8e44ad);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(142, 68, 173, 0.4);
        }


        .btn-warning {
            background: linear-gradient(135deg, #e67e22, #f39c12);
            color: white;
        }
        .btn-warning:hover {
            background: linear-gradient(135deg, #d35400, #e67e22);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(230, 126, 34, 0.4);
        }

        .table-section {
            padding: 30px;
            overflow-x: auto;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-filter {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-filter input,
        .search-filter select {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 15px 12px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            text-align: center;
            font-size: 0.85rem;
            max-width: 150px; /* Adjust as needed */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .data-table td:nth-child(12), /* Description */
        .data-table td:nth-child(13) { /* Solution */
            white-space: normal; /* Allow wrapping for longer text */
            min-width: 200px;
        }


        .data-table tr:hover {
            background-color: #f8f9fa;
            /* transform: scale(1.01); remove row scale for better usability with wrapped text */
            transition: background-color 0.2s ease;
        }
        
        .priority-high-cell { background-color: #ffebee; color: #c62828; }
        .priority-medium-cell { background-color: #fff3e0; color: #ef6c00; }
        .priority-low-cell { background-color: #e8f5e9; color: #2e7d32; }

        .status-pending { 
            background-color: #fff3cd; 
            color: #856404; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-weight: bold;
            display: inline-block;
        }

        .status-resolved { 
            background-color: #d4edda; 
            color: #155724; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-weight: bold;
            display: inline-block;
        }

        .status-in-progress { 
            background-color: #cce7ff; 
            color: #004085; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-weight: bold;
            display: inline-block;
        }

        .delete-btn, .edit-btn {
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            margin: 2px;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .delete-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .edit-btn {
            background: #3498db;
            color: white;
        }

        .edit-btn:hover {
            background: #2980b9;
            transform: scale(1.05);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%; /* Center horizontally */
            transform: translateX(-50%); /* Adjust for centering */
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, top 0.3s ease;
            min-width: 250px;
            text-align: center;
        }

        .notification.show {
            opacity: 1;
            visibility: visible;
            top: 30px; /* Slide down a bit */
        }

        .notification.success {
            background: #27ae60;
        }

        .notification.error {
            background: #e74c3c;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .search-filter {
                flex-direction: column;
                width: 100%; /* Make filter elements full width */
            }
            .search-filter input, .search-filter select, .search-filter button {
                width: 100%;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .data-table {
                font-size: 0.75rem;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 6px;
            }
             .data-table td:nth-child(12), /* Description */
             .data-table td:nth-child(13) { /* Solution */
                min-width: 100px; /* Adjust for smaller screens */
            }


            .btn {
                padding: 12px 20px;
                font-size: 1rem;
                width: 100%; /* Make form buttons full width on small screens */
            }
            .sharing-notice div .btn { /* Keep sharing buttons side-by-side if possible */
                 width: auto;
            }
        }
    </style>
</head>
<body>
<div class="container">
<div class="header">
<h1> متابعة أعطال السيرفرات والأدوات</h1>
<p>نظام توثيق شامل لمتابعة الأعطال والصيانات</p>
<div class="sync-status">
<div class="sync-indicator">
<div class="sync-dot"></div>
<span>نشط</span>
</div>
</div>
</div>

<div class="form-section">
<h2 style="color: #2c3e50; margin-bottom: 20px; font-size: 1.5rem;">📝 إضافة/تعديل حدث</h2>
<form id="issueForm">
<div class="form-grid">
<div class="form-group">
<label for="region">المنطقة *</label>
<select id="region" required="">
<option value="">اختر المنطقة</option>
<option value="القاهرة">القاهرة</option>
<option value="الجيزة">الجيزة</option>
<option value="الإسكندرية">الإسكندرية</option>
<option value="الدقهلية">الدقهلية</option>
<option value="الشرقية">الشرقية</option>
<option value="القليوبية">القليوبية</option>
<option value="كفر الشيخ">كفر الشيخ</option>
<option value="الغربية">الغربية</option>
<option value="المنوفية">المنوفية</option>
<option value="البحيرة">البحيرة</option>
<option value="الإسماعيلية">الإسماعيلية</option>
<option value="بورسعيد">بورسعيد</option>
<option value="السويس">السويس</option>
<option value="شمال سيناء">شمال سيناء</option>
<option value="جنوب سيناء">جنوب سيناء</option>
<option value="الفيوم">الفيوم</option>
<option value="بني سويف">بني سويف</option>
<option value="المنيا">المنيا</option>
<option value="أسيوط">أسيوط</option>
<option value="سوهاج">سوهاج</option>
<option value="قنا">قنا</option>
<option value="أسوان">أسوان</option>
<option value="الأقصر">الأقصر</option>
<option value="البحر الأحمر">البحر الأحمر</option>
<option value="الوادي الجديد">الوادي الجديد</option>
<option value="مطروح">مطروح</option>
</select>
</div>
<div class="form-group">
<label for="issueType">نوع المشكلة *</label>
<select id="issueType" required="">
<option value="">اختر نوع المشكلة</option>
<option value="عطل سيرفر">عطل سيرفر</option>
<option value="صيانة سيرفر">صيانة سيرفر</option>
<option value="عطل قاعدة بيانات">عطل قاعدة بيانات</option>
<option value="عطل أداة إدخال">عطل أداة إدخال</option>
<option value="مشكلة في الرسم">مشكلة في الرسم</option>
<option value="تحديث أداة">تحديث أداة</option>
<option value="مشكلة شبكة">مشكلة شبكة</option>
<option value="أخرى">أخرى</option>
</select>
</div>
<div class="form-group">
<label for="priority">الأولوية *</label>
<select id="priority" required="">
<option value="">اختر الأولوية</option>
<option value="عالية">عالية</option>
<option value="متوسطة">متوسطة</option>
<option value="منخفضة">منخفضة</option>
</select>
</div>
<div class="form-group">
<label for="contactPerson">اسم الشخص المتواصل *</label>
<input id="contactPerson" placeholder="اسم الشخص من الإدارة الأخرى" required="" type="text"/>
</div>
<div class="form-group">
<label for="reportedBy">المُبلغ عن المشكلة *</label>
<input id="reportedBy" placeholder="اسم الموظف المُبلغ" required="" type="text"/>
</div>
<div class="form-group">
<label for="affectedSystem">النظام المتأثر</label>
<input id="affectedSystem" placeholder="اسم النظام أو البرنامج المتأثر" type="text"/>
</div>
</div>
<div class="form-grid">
<div class="form-group">
<label for="startTime">وقت بداية المشكلة *</label>
<input id="startTime" required="" type="datetime-local"/>
</div>
<div class="form-group">
<label for="endTime">وقت انتهاء المشكلة</label>
<input id="endTime" type="datetime-local"/>
</div>
<div class="form-group">
<label for="status">حالة المشكلة *</label>
<select id="status" required="">
<option value="">اختر الحالة</option>
<option value="معلقة">معلقة</option>
<option value="قيد المعالجة">قيد المعالجة</option>
<option value="محلولة">محلولة</option>
</select>
</div>
<div class="form-group">
<label for="duration">مدة التعطيل (بالدقائق)</label>
<input id="duration" placeholder="المدة بالدقائق (تحسب تلقائياً إذا أمكن)" type="number"/>
</div>
</div>
<div class="form-group">
<label for="description">وصف المشكلة *</label>
<textarea id="description" placeholder="وصف تفصيلي للمشكلة والأعراض" required=""></textarea>
</div>
<div class="form-group">
<label for="solution">الحل المطبق</label>
<textarea id="solution" placeholder="وصف الحل أو الإجراءات المتخذة"></textarea>
</div>
<div class="form-group">
<label for="notes">ملاحظات إضافية</label>
<textarea id="notes" placeholder="أي ملاحظات أخرى مهمة"></textarea>
</div>
<div style="display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
<button class="btn btn-primary" type="submit">إضافة البيان</button>
<button class="btn btn-warning" onclick="clearAllData()" type="button">مسح جميع البيانات المخزنة</button>

</div>
</form>
</div>
<div class="form-section">
<h2 style="color: #2c3e50; margin-bottom: 20px; font-size: 1.5rem;">📈 إحصائيات سريعة</h2>
<div class="stats" id="stats">
<div class="stat-card">
<h3 id="totalIssues">0</h3>
<p>إجمالي المشاكل</p>
</div>
<div class="stat-card">
<h3 id="pendingIssues">0</h3>
<p>المشاكل المعلقة/قيد المعالجة</p>
</div>
<div class="stat-card">
<h3 id="resolvedIssues">0</h3>
<p>المشاكل المحلولة</p>
</div>
<div class="stat-card">
<h3 id="avgDowntime">0</h3>
<p>متوسط وقت التعطيل (دقيقة)</p>
</div>
</div>
</div>
<div class="table-section">
<div class="controls">
<h2 style="color: #2c3e50; font-size: 1.5rem;">📋 سجل الأحداث</h2>
<div class="search-filter">
<input id="searchInput" placeholder="البحث في السجلات..." type="text"/>
<select id="filterRegion">
<option value="">جميع المناطق</option>
</select>
<select id="filterStatus">
<option value="">جميع الحالات</option>
<option value="معلقة">معلقة</option>
<option value="قيد المعالجة">قيد المعالجة</option>
<option value="محلولة">محلولة</option>
</select>
<select id="filterPriority">
<option value="">جميع الأولويات</option>
<option value="عالية">عالية</option>
<option value="متوسطة">متوسطة</option>
<option value="منخفضة">منخفضة</option>
</select>
<button class="btn" onclick="clearFilters()" style="background: #95a5a6; color: white; padding: 10px 15px; font-size:0.9rem;">مسح الفلاتر</button>
</div>
</div>
<div id="tableContainer">
<div class="no-data">
<p>لا توجد بيانات للعرض. يرجى إضافة أول حدث أو استيراد ملف.</p>
</div>
</div>
</div>
</div>
<div class="notification" id="notification"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
        let issuesData = [];
        let currentEditIndex = -1; // -1 for new, otherwise index of item being edited

        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            loadRegionsInFilter(); // Populate filter dropdown
            updateTable();
            updateStats();
            
            document.getElementById('startTime').value = getCurrentDateTime();
            
            document.getElementById('issueForm').addEventListener('submit', handleSubmit);
            document.getElementById('searchInput').addEventListener('input', updateTable);
            document.getElementById('filterRegion').addEventListener('change', updateTable);
            document.getElementById('filterStatus').addEventListener('change', updateTable);
            document.getElementById('filterPriority').addEventListener('change', updateTable);
            document.getElementById('priority').addEventListener('change', updatePriorityStyle);

            // Auto-calculate duration
            document.getElementById('startTime').addEventListener('change', calculateDuration);
            document.getElementById('endTime').addEventListener('change', calculateDuration);
        });

        function getCurrentDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function calculateDuration() {
            const startTimeStr = document.getElementById('startTime').value;
            const endTimeStr = document.getElementById('endTime').value;
            const durationInput = document.getElementById('duration');

            if (startTimeStr && endTimeStr) {
                const start = new Date(startTimeStr);
                const end = new Date(endTimeStr);
                if (end > start) {
                    const diffMillis = end - start;
                    durationInput.value = Math.round(diffMillis / 60000); // milliseconds to minutes
                } else {
                    durationInput.value = ''; // Or 0, or show an error
                }
            } else {
                // durationInput.value = ''; // Keep existing manual value if one time is missing
            }
        }


        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`; // Reset classes then add specific type
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function saveData() {
            try {
                const dataToSave = {
                    data: issuesData,
                    lastSaved: new Date().toISOString(),
                    version: '1.1' // Increment version if schema changes
                };
                localStorage.setItem('serverIssuesData', JSON.stringify(dataToSave));
                // No success message for every save to avoid being too chatty, 
                // unless it's a major operation like import.
            } catch (e) {
                console.error('Failed to save data to localStorage:', e);
                showNotification('فشل حفظ البيانات محلياً. قد تكون مساحة التخزين ممتلئة.', 'error');
            }
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('serverIssuesData');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (parsed.data && Array.isArray(parsed.data)) {
                        issuesData = parsed.data;
                        // showNotification('تم تحميل البيانات المحفوظة محلياً بنجاح.');
                    } else {
                        issuesData = [];
                    }
                } else {
                    issuesData = [];
                }
            } catch (e) {
                console.error('Failed to load data from localStorage:', e);
                issuesData = [];
                showNotification('فشل تحميل البيانات المحلية. قد يكون الملف تالفًا أو أن التنسيق غير صحيح.', 'error');
            }
        }

        function loadRegionsInFilter() {
            const staticRegionSelect = document.getElementById('region');
            const filterRegionSelect = document.getElementById('filterRegion');
            const currentFilterValue = filterRegionSelect.value; // Preserve selected filter

            while (filterRegionSelect.options.length > 1) {
                filterRegionSelect.remove(1);
            }

            const regionsFromData = [...new Set(issuesData.map(item => item.region).filter(Boolean))];
            const staticRegions = [];
            for (let i = 1; i < staticRegionSelect.options.length; i++) {
                staticRegions.push(staticRegionSelect.options[i].value);
            }

            const allUniqueRegions = [...new Set([...staticRegions, ...regionsFromData])].sort();

            allUniqueRegions.forEach(regionValue => {
                if (regionValue) {
                    const option = document.createElement('option');
                    option.value = regionValue;
                    option.textContent = regionValue;
                    filterRegionSelect.appendChild(option);
                }
            });
            filterRegionSelect.value = currentFilterValue; // Restore selection if possible
        }


        function updatePriorityStyle() {
            const prioritySelect = document.getElementById('priority');
            const priority = prioritySelect.value;
            
            prioritySelect.className = 'form-group select'; // Reset base class
            if (priority === 'عالية') {
                prioritySelect.classList.add('priority-high');
            } else if (priority === 'متوسطة') {
                prioritySelect.classList.add('priority-medium');
            } else if (priority === 'منخفضة') {
                prioritySelect.classList.add('priority-low');
            }
        }

        function handleSubmit(e) {
            e.preventDefault();
            calculateDuration(); // Ensure duration is up-to-date before saving

            const formData = {
                id: currentEditIndex >= 0 ? issuesData[currentEditIndex].id : Date.now() + Math.random().toString(36).substr(2, 9), // More unique ID
                region: document.getElementById('region').value,
                issueType: document.getElementById('issueType').value,
                priority: document.getElementById('priority').value,
                contactPerson: document.getElementById('contactPerson').value,
                reportedBy: document.getElementById('reportedBy').value,
                affectedSystem: document.getElementById('affectedSystem').value,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                status: document.getElementById('status').value,
                duration: document.getElementById('duration').value,
                description: document.getElementById('description').value,
                solution: document.getElementById('solution').value,
                notes: document.getElementById('notes').value,
                lastModified: new Date().toISOString()
            };

            if (currentEditIndex >= 0) { // Editing existing item
                formData.timestamp = issuesData[currentEditIndex].timestamp || new Date(formData.id).toISOString(); // Preserve original timestamp if exists
                issuesData[currentEditIndex] = formData;
                showNotification('تم تحديث البيان بنجاح');
            } else { // Adding new item
                formData.timestamp = new Date().toISOString(); // Timestamp for creation
                issuesData.unshift(formData); // Add to the beginning of the array for most recent first
                showNotification('تم إضافة البيان بنجاح');
            }
            
            saveData();
            resetForm();
            updateTable();
            updateStats();
            loadRegionsInFilter(); // Update regions in filter if a new one was added
        }

        function resetForm() {
            document.getElementById('issueForm').reset();
            document.getElementById('startTime').value = getCurrentDateTime();
            document.getElementById('endTime').value = '';
            document.getElementById('duration').value = '';
            const prioritySelect = document.getElementById('priority');
            prioritySelect.className = ''; // Remove priority-specific classes
            prioritySelect.selectedIndex = 0;
            
            document.getElementById('region').selectedIndex = 0;
            document.getElementById('issueType').selectedIndex = 0;
            document.getElementById('status').selectedIndex = 0;

            currentEditIndex = -1;
            document.querySelector('#issueForm button[type="submit"]').textContent = 'إضافة البيان';
        }

        function updateTable() {
            const tableContainer = document.getElementById('tableContainer');
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const filterRegionValue = document.getElementById('filterRegion').value;
            const filterStatusValue = document.getElementById('filterStatus').value;
            const filterPriorityValue = document.getElementById('filterPriority').value;

            const filteredData = issuesData.filter(item => {
                const matchesSearch = (
                    (item.region && item.region.toLowerCase().includes(searchInput)) ||
                    (item.issueType && item.issueType.toLowerCase().includes(searchInput)) ||
                    (item.priority && item.priority.toLowerCase().includes(searchInput)) ||
                    (item.contactPerson && item.contactPerson.toLowerCase().includes(searchInput)) ||
                    (item.reportedBy && item.reportedBy.toLowerCase().includes(searchInput)) ||
                    (item.affectedSystem && item.affectedSystem.toLowerCase().includes(searchInput)) ||
                    (item.status && item.status.toLowerCase().includes(searchInput)) ||
                    (item.description && item.description.toLowerCase().includes(searchInput)) ||
                    (item.solution && item.solution.toLowerCase().includes(searchInput)) ||
                    (item.notes && item.notes.toLowerCase().includes(searchInput))
                );
                const matchesRegion = !filterRegionValue || item.region === filterRegionValue;
                const matchesStatus = !filterStatusValue || item.status === filterStatusValue;
                const matchesPriority = !filterPriorityValue || item.priority === filterPriorityValue;
                return matchesSearch && matchesRegion && matchesStatus && matchesPriority;
            });

            if (filteredData.length === 0) {
                tableContainer.innerHTML = `<div class="no-data"><p>لا توجد بيانات للعرض تطابق معايير البحث أو الفلترة الحالية. حاول تعديل الفلاتر أو إضافة بيانات جديدة.</p></div>`;
                return;
            }

            tableContainer.innerHTML = createTableHTML(filteredData);
        }

        function createTableHTML(data) {
            let tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>م</th>
                            <th>المنطقة</th>
                            <th>نوع المشكلة</th>
                            <th>الأولوية</th>
                            <th>الشخص المتواصل</th>
                            <th>المُبلغ</th>
                            <th>النظام المتأثر</th>
                            <th>وقت البداية</th>
                            <th>وقت النهاية</th>
                            <th>المدة (دقائق)</th>
                            <th>الحالة</th>
                            <th>الوصف</th>
                            <th>الحل</th>
                            <th>ملاحظات</th>
                            <th>إجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            data.forEach((item, displayIndex) => {
                const originalIndex = issuesData.findIndex(d => d.id === item.id);
                tableHTML += `
                    <tr>
                        <td>${displayIndex + 1}</td>
                        <td title="${item.region || ''}">${item.region || '-'}</td>
                        <td title="${item.issueType || ''}">${item.issueType || '-'}</td>
                        <td title="${item.priority || ''}" class="${item.priority === 'عالية' ? 'priority-high-cell' : item.priority === 'متوسطة' ? 'priority-medium-cell' : item.priority === 'منخفضة' ? 'priority-low-cell' : ''}">${item.priority || '-'}</td>
                        <td title="${item.contactPerson || ''}">${item.contactPerson || '-'}</td>
                        <td title="${item.reportedBy || ''}">${item.reportedBy || '-'}</td>
                        <td title="${item.affectedSystem || ''}">${item.affectedSystem || '-'}</td>
                        <td title="${item.startTime ? new Date(item.startTime).toLocaleString('ar-EG', {dateStyle:'short', timeStyle:'short'}) : ''}">${item.startTime ? new Date(item.startTime).toLocaleString('ar-EG', {dateStyle:'short', timeStyle:'short'}) : '-'}</td>
                        <td title="${item.endTime ? new Date(item.endTime).toLocaleString('ar-EG', {dateStyle:'short', timeStyle:'short'}) : ''}">${item.endTime ? new Date(item.endTime).toLocaleString('ar-EG', {dateStyle:'short', timeStyle:'short'}) : '-'}</td>
                        <td title="${item.duration || ''}">${item.duration || '-'}</td>
                        <td><span class="status-${item.status === 'محلولة' ? 'resolved' : item.status === 'قيد المعالجة' ? 'in-progress' : 'pending'}">${item.status || '-'}</span></td>
                        <td title="${item.description || ''}"><div style="max-height: 60px; overflow-y: auto;">${item.description || '-'}</div></td>
                        <td title="${item.solution || ''}"><div style="max-height: 60px; overflow-y: auto;">${item.solution || '-'}</div></td>
                        <td title="${item.notes || ''}"><div style="max-height: 60px; overflow-y: auto;">${item.notes || '-'}</div></td>
                        <td>
                            <button class="edit-btn" onclick="editIssue(${originalIndex})">تعديل</button>
                            <button class="delete-btn" onclick="deleteIssue(${originalIndex})">حذف</button>
                        </td>
                    </tr>
                `;
            });
            tableHTML += `</tbody></table>`;
            return tableHTML;
        }
        
        function editIssue(index) {
            if (index < 0 || index >= issuesData.length) return;
            currentEditIndex = index;
            const item = issuesData[index];

            document.getElementById('region').value = item.region || '';
            document.getElementById('issueType').value = item.issueType || '';
            document.getElementById('priority').value = item.priority || '';
            updatePriorityStyle();
            document.getElementById('contactPerson').value = item.contactPerson || '';
            document.getElementById('reportedBy').value = item.reportedBy || '';
            document.getElementById('affectedSystem').value = item.affectedSystem || '';
            document.getElementById('startTime').value = item.startTime || '';
            document.getElementById('endTime').value = item.endTime || '';
            document.getElementById('status').value = item.status || '';
            document.getElementById('duration').value = item.duration || '';
            document.getElementById('description').value = item.description || '';
            document.getElementById('solution').value = item.solution || '';
            document.getElementById('notes').value = item.notes || '';

            document.querySelector('#issueForm button[type="submit"]').textContent = 'تحديث البيان';
            document.getElementById('issueForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
            document.getElementById('region').focus();
        }

        function deleteIssue(index) {
            if (index < 0 || index >= issuesData.length) return;
            const itemDescription = (issuesData[index].description || "بيان بدون وصف").substring(0, 30) + "...";
            if (confirm(`هل أنت متأكد من حذف هذا البيان؟\n"${itemDescription}"`)) {
                issuesData.splice(index, 1);
                saveData();
                updateTable();
                updateStats();
                loadRegionsInFilter(); // In case the deleted item was the only one from a region
                showNotification('تم حذف البيان بنجاح');
            }
        }

        function updateStats() {
            document.getElementById('totalIssues').textContent = issuesData.length;
            const pending = issuesData.filter(item => item.status === 'معلقة' || item.status === 'قيد المعالجة').length;
            document.getElementById('pendingIssues').textContent = pending;
            const resolved = issuesData.filter(item => item.status === 'محلولة').length;
            document.getElementById('resolvedIssues').textContent = resolved;

            let totalDowntime = 0;
            let resolvedWithDuration = 0;
            issuesData.forEach(item => {
                if (item.status === 'محلولة' && item.duration && !isNaN(parseFloat(item.duration))) {
                    totalDowntime += parseFloat(item.duration);
                    resolvedWithDuration++;
                }
            });
            const avgDowntime = resolvedWithDuration > 0 ? (totalDowntime / resolvedWithDuration).toFixed(0) : 0;
            document.getElementById('avgDowntime').textContent = avgDowntime;
        }
        
        function exportToJSON() {
            if (issuesData.length === 0) {
                showNotification('لا توجد بيانات لتصديرها', 'error');
                return;
            }
            const jsonData = JSON.stringify({ data: issuesData, exportDate: new Date().toISOString(), version: '1.1' }, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const now = new Date();
            const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
            a.download = `issues_backup_${timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('تم تصدير البيانات كملف JSON بنجاح');
        }

        function exportToExcel() {
            if (issuesData.length === 0) {
                showNotification('لا توجد بيانات لتصديرها', 'error');
                return;
            }
            const dataForExcel = issuesData.map(item => ({
                "المنطقة": item.region,
                "نوع المشكلة": item.issueType,
                "الأولوية": item.priority,
                "الشخص المتواصل": item.contactPerson,
                "المُبلغ عن المشكلة": item.reportedBy,
                "النظام المتأثر": item.affectedSystem || '',
                "وقت بداية المشكلة": item.startTime ? new Date(item.startTime).toLocaleString('ar-EG', {dateStyle:'medium', timeStyle:'short'}) : '',
                "وقت انتهاء المشكلة": item.endTime ? new Date(item.endTime).toLocaleString('ar-EG', {dateStyle:'medium', timeStyle:'short'}) : '',
                "مدة التعطيل (بالدقائق)": item.duration || '',
                "حالة المشكلة": item.status,
                "وصف المشكلة": item.description,
                "الحل المطبق": item.solution || '',
                "ملاحظات إضافية": item.notes || '',
                "تاريخ التسجيل": item.timestamp ? new Date(item.timestamp).toLocaleString('ar-EG', {dateStyle:'medium', timeStyle:'short'}) : '',
                "آخر تعديل": item.lastModified ? new Date(item.lastModified).toLocaleString('ar-EG', {dateStyle:'medium', timeStyle:'short'}) : ''
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataForExcel);
            const columnWidths = [
                {wch:15},{wch:18},{wch:10},{wch:20},{wch:20},{wch:20}, // م to النظام
                {wch:22},{wch:22},{wch:15},{wch:12}, // تواريخ, مدة, حالة
                {wch:40},{wch:40},{wch:30},{wch:22},{wch:22} // وصف, حل, ملاحظات, تواريخ تسجيل وتعديل
            ];
            worksheet['!cols'] = columnWidths;
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "سجل الأعطال");
            
            const now = new Date();
            const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
            XLSX.writeFile(workbook, `issues_export_${timestamp}.xlsx`);
            showNotification('تم تصدير البيانات كملف Excel بنجاح');
        }

        function importFromFile() {
            document.getElementById('fileInput').click();
        }
        
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (file.name.endsWith('.json')) {
                        importFromJSON(e.target.result);
                    } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        importFromExcel(e.target.result);
                    } else {
                        showNotification('صيغة الملف غير مدعومة. يرجى استخدام JSON أو Excel (xlsx, xls).', 'error');
                    }
                } catch (err) {
                    console.error("Error processing file:", err);
                    showNotification('حدث خطأ أثناء معالجة الملف: ' + err.message, 'error');
                } finally {
                    event.target.value = null; 
                }
            };
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }

        function importFromJSON(jsonDataString) {
            let parsedData;
            try {
                 parsedData = JSON.parse(jsonDataString);
            } catch (e) {
                showNotification('ملف JSON تالف أو غير صحيح.', 'error');
                return;
            }
           
            let importedIssues = [];
            if (parsedData.data && Array.isArray(parsedData.data)) {
                 importedIssues = parsedData.data;
            } else if (Array.isArray(parsedData)) {
                 importedIssues = parsedData;
            } else {
                showNotification('ملف JSON غير متوافق أو فارغ (البيانات يجب أن تكون داخل مفتاح "data" كقائمة، أو قائمة مباشرة).', 'error');
                return;
            }

            importedIssues = importedIssues.filter(item => item.description && item.region && item.issueType && item.startTime); // Basic validation

            if (importedIssues.length > 0) {
                if (confirm(`سيتم استبدال البيانات الحالية (${issuesData.length} سجل) بالبيانات المستوردة (${importedIssues.length} سجل). هل تريد المتابعة؟`)) {
                    issuesData = importedIssues.map(item => ({ // Ensure all items have an id and timestamps
                        ...item,
                        id: item.id || Date.now() + Math.random().toString(36).substr(2, 9),
                        timestamp: item.timestamp || new Date().toISOString(),
                        lastModified: item.lastModified || new Date().toISOString()
                    }));
                    saveData();
                    updateTable();
                    updateStats();
                    loadRegionsInFilter();
                    showNotification(`تم استيراد ${importedIssues.length} سجل بنجاح.`);
                }
            } else {
                showNotification('لم يتم العثور على بيانات صالحة (تتطلب وصف، منطقة، نوع المشكلة، ووقت بداية) في ملف JSON.', 'error');
            }
        }

        function importFromExcel(arrayBuffer) {
            const data = new Uint8Array(arrayBuffer);
            const workbook = XLSX.read(data, { type: "array", cellDates:true }); // cellDates helps with date objects
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false }); // raw:false for formatted strings

            if (jsonData.length === 0) {
                showNotification('ملف Excel فارغ أو لا يحتوي على بيانات.', 'error');
                return;
            }
            
            const headerMapping = { // Keys are common Excel headers (allow flexibility), values are our internal keys
                "المنطقة": "region", "Region": "region",
                "نوع المشكلة": "issueType", "Issue Type": "issueType",
                "الأولوية": "priority", "Priority": "priority",
                "الشخص المتواصل": "contactPerson", "Contact Person": "contactPerson",
                "المُبلغ عن المشكلة": "reportedBy", "Reported By": "reportedBy",
                "النظام المتأثر": "affectedSystem", "Affected System": "affectedSystem",
                "وقت بداية المشكلة": "startTime", "Start Time": "startTime",
                "وقت انتهاء المشكلة": "endTime", "End Time": "endTime",
                "مدة التعطيل (بالدقائق)": "duration", "Duration (min)": "duration",
                "حالة المشكلة": "status", "Status": "status",
                "وصف المشكلة": "description", "Description": "description",
                "الحل المطبق": "solution", "Solution": "solution",
                "ملاحظات إضافية": "notes", "Notes": "notes",
                "تاريخ التسجيل": "timestamp", "Timestamp": "timestamp",
                "آخر تعديل": "lastModified", "Last Modified": "lastModified"
            };
            
            const importedIssues = [];
            jsonData.forEach((row, i) => {
                const issue = { 
                    id: Date.now() + i + Math.random().toString(36).substr(2, 9) // Generate new ID
                };
                let hasRequiredFields = true;

                for (const excelHeader in row) {
                    const internalKey = Object.keys(headerMapping).find(key => excelHeader.trim().toLowerCase() === key.toLowerCase());
                    if (headerMapping[internalKey]) {
                         let value = row[excelHeader];
                         if ((headerMapping[internalKey] === 'startTime' || headerMapping[internalKey] === 'endTime' || headerMapping[internalKey] === 'timestamp' || headerMapping[internalKey] === 'lastModified') && value) {
                            let dateValue = value instanceof Date ? value : new Date(value);
                            if (!isNaN(dateValue.getTime())) {
                                issue[headerMapping[internalKey]] = `${dateValue.getFullYear()}-${String(dateValue.getMonth() + 1).padStart(2, '0')}-${String(dateValue.getDate()).padStart(2, '0')}T${String(dateValue.getHours()).padStart(2, '0')}:${String(dateValue.getMinutes()).padStart(2, '0')}`;
                            } else {
                                issue[headerMapping[internalKey]] = String(value); // Keep as string if not valid date
                            }
                        } else {
                            issue[headerMapping[internalKey]] = String(value);
                        }
                    }
                }
                
                // Check for minimum required fields for an issue to be valid
                if (!issue.description || !issue.region || !issue.issueType || !issue.startTime) {
                    hasRequiredFields = false;
                }
                // Add defaults if missing
                if (!issue.priority) issue.priority = "متوسطة";
                if (!issue.contactPerson) issue.contactPerson = "غير محدد";
                if (!issue.reportedBy) issue.reportedBy = "غير محدد";
                if (!issue.status) issue.status = "معلقة";
                if (!issue.timestamp) issue.timestamp = new Date().toISOString();
                if (!issue.lastModified) issue.lastModified = new Date().toISOString();

                if (hasRequiredFields) {
                    importedIssues.push(issue);
                }
            });
            
            if (importedIssues.length > 0) {
                if (confirm(`سيتم استبدال البيانات الحالية (${issuesData.length} سجل) بالبيانات المستوردة (${importedIssues.length} سجل من Excel). هل تريد المتابعة؟`)) {
                    issuesData = importedIssues;
                    saveData();
                    updateTable();
                    updateStats();
                    loadRegionsInFilter();
                    showNotification(`تم استيراد ${importedIssues.length} سجل من ملف Excel بنجاح.`);
                }
            } else {
                showNotification('لم يتم العثور على بيانات صالحة في ملف Excel. تأكد من وجود أعمدة بالأسماء المتوقعة (مثل المنطقة، نوع المشكلة، وصف المشكلة، وقت بداية المشكلة) أو أن البيانات تحتوي على القيم المطلوبة.', 'error');
            }
        }

        function clearAllData() {
            if (confirm('هل أنت متأكد من مسح جميع البيانات المخزنة محلياً؟ هذا الإجراء لا يمكن التراجع عنه.')) {
                if (confirm('تأكيد أخير: مسح جميع البيانات نهائياً؟')) {
                    issuesData = [];
                    localStorage.removeItem('serverIssuesData'); // Also clear from localStorage directly
                    updateTable();
                    updateStats();
                    loadRegionsInFilter();
                    resetForm(); // Reset form as well
                    showNotification('تم مسح جميع البيانات بنجاح.');
                }
            }
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterRegion').selectedIndex = 0;
            document.getElementById('filterStatus').selectedIndex = 0;
            document.getElementById('filterPriority').selectedIndex = 0;
            updateTable();
            showNotification('تم مسح الفلاتر.');
        }
    </script>
<script>
function sendToGoogleSheet(formData) {
    fetch("https://script.google.com/macros/s/AKfycbwwTkZt0qynXgbaUNS0QE2o-sgrLGm5rbqWE20PKz0SAszaua1QIWx_ilWtY2Nx3dJOog/exec", {
        method: "POST",
        mode: "no-cors",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(formData)
    })
    .then(() => {
        showNotification("✅ تم إرسال البيانات إلى Google Sheet بنجاح");
    })
    .catch((error) => {
        showNotification("❌ فشل في إرسال البيانات", "error");
        console.error("Google Sheet Error:", error);
    });
}

// تعديل بسيط على handleSubmit ليرسل البيانات
const originalHandleSubmit = handleSubmit;
handleSubmit = function(e) {
    e.preventDefault();
    calculateDuration();

    const formData = {
        region: document.getElementById('region').value,
        issueType: document.getElementById('issueType').value,
        priority: document.getElementById('priority').value,
        contactPerson: document.getElementById('contactPerson').value,
        reportedBy: document.getElementById('reportedBy').value,
        affectedSystem: document.getElementById('affectedSystem').value,
        startTime: document.getElementById('startTime').value,
        endTime: document.getElementById('endTime').value,
        status: document.getElementById('status').value,
        duration: document.getElementById('duration').value,
        description: document.getElementById('description').value,
        solution: document.getElementById('solution').value,
        notes: document.getElementById('notes').value,
        timestamp: new Date().toISOString(),
        lastModified: new Date().toISOString()
    };

    sendToGoogleSheet(formData);
    resetForm();
};
</script>
</body>
</html>